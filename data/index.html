<html>
    <head>
        <title>%device_name%</title>
<style>
body {
    font-size: 36px;
}
h2 {
    margin-block-end: 0px;
}

#add_checkbox {
    height: 36px;
    width: 36px;
}
.slider {
    width: 400px;
}

button {
    background-color: #888888; /* gray */
    margin-bottom:5px;
    border-color:white;
    border: 40px;
    color: white;
    padding: 5px 15px;
    text-align: center;
    text-decoration: none;
    display: inline-block;
    font-size: 36px;
}
.small {
    font-size:20px;
    align: center;
}
</style>
    </head>
    <body>
        <template id="color-button">
            <span style='display:inline-block;text-align:center;'>
            <svg  width="80" height="80">
                <rect id="color-box" x=5 y=5 width="70" height="70" rx=15 style="fill:rgb(0,0,0);stroke-width:3;stroke:rgb(150,150,150)" />
            </svg>
            <br>
            <span class="small" id='label' '></span>
            </span>
        </template>
        <script>
            var the_element;
            customElements.define('color-button',
                class extends HTMLElement {
                    constructor() {
                        super();
                        this.template = document.getElementById('color-button');
                        the_element = this;
                    }

                    // using connected compenent instead of shadow dom so styles can be inheritd
                    connectedCallback() {
                        let e=document.importNode(this.template.content, true);
                        this.appendChild(e);
                        let r = this.getAttribute('r');
                        let g = this.getAttribute('g');
                        let b = this.getAttribute('b');
                        let method = this.getAttribute('method');


                        // get full colors to use on screen
                        let v = Math.max(r,g,b)
                        let screen_r = v == 0 ? r : r*255/v;
                        let screen_g = v == 0 ? g : g*255/v;
                        let screen_b = v == 0 ? b : b*255/v;
                        let screen_color = 'rgb('+screen_r+","+screen_g+","+screen_b+')';
                        this.querySelector("#color-box").style.fill=screen_color;
                        let t = this.innerText;
                        this.querySelector("#label").innerText = this.getAttribute('name');
                        //this.innerText = "";
                        
                        this.querySelector("#color-box").addEventListener("mousedown", function() {
                            let color = String(r)+" "+g+" "+b;
                            if(method=="add") {
                                command("add " + color);
                            } else {
                                command("color " + color);
                            }
                        });
                        // e.addEventListener("mousedown", function() {
                        //     set_color(String(r)+" "+g+" "+b);
                        // });

                    }
                }
            );

            function log_scale(p, minp=0, maxp=100, min=0.1, max=10) {
                // The result should be between min and max
                var minv = Math.log(min);
                var maxv = Math.log(max);

                // calculate adjustment factor
                var scale = (maxv-minv) / (maxp-minp);

                return Math.exp(minv + scale*(p-minp));
            }

            function set_color(c) {
                let add_checked = document.getElementById('add_checkbox').checked;
                let cmd = (add_checked ? "add " : "color ") + c;
                command(cmd);
            }

            function command(s) {
                let r = new XMLHttpRequest();
                r.open("POST", "command");
                r.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8");
                r.send(s);
            }
            function power_on() {
                command("on");
            }

            function power_off() {
                command("off");
            }

            function cycles_input() {
                let cycles_p = parseInt(document.getElementById("cycles").value);
                let cycles = log_scale(cycles_p, 1, 100, 0.01, 10);
                let cycles_str = cycles.toFixed(2);
                document.getElementById('cycles_value').innerHTML = cycles_str;
            }

            function cycles_change() {
                let v = document.getElementById('cycles_value').innerHTML
                command("cycles "+ v);
            }

            function speed_input() {
                let speed_p = parseInt(document.getElementById("speed").value);
                let speed = log_scale(speed_p, 1, 100, 0.01, 10);
                let speed_str = speed.toFixed(2);
                document.getElementById('speed_value').innerHTML = speed_str;
            }

            function speed_change() {
                let v = document.getElementById('speed_value').innerHTML
                command("speed "+ v);
            }

            function brightness_input() {
                let brightness = parseInt(document.getElementById("brightness").value);
                let brightness_str = String(brightness);
                document.getElementById('brightness_value').innerHTML = brightness_str;
            }

            function brightness_change() {
                let v = document.getElementById('brightness_value').innerHTML
                command("brightness "+ v);
            }

            function saturation_input() {
                let saturation = parseInt(document.getElementById("saturation").value);
                let saturation_str = String(saturation);
                document.getElementById('saturation_value').innerHTML = saturation_str;
            }

            function saturation_change() {
                let v = document.getElementById('saturation_value').innerHTML
                command("saturation "+ v);
            }
        </script>

        <h1>%device_name%</h1>
        <button onmousedown="power_on()">on</button> <button onmousedown="power_off()">off</button>

        <h2>Effects</h2>
        <button onmousedown="command('rainbow')">rainbow</button>
        <button onmousedown="command('twinkle')">twinkle</button>
        <button onmousedown="command('pattern1')">pattern1</button>
        <button onmousedown="command('color 30 0 0\nadd 200 0 0\nadd 200 15 0\nadd 100 15 0\nadd 200 40 0\ntwinkle')">embers</button>
        <button onmousedown='command("color 5 5 30\nadd 0 0 255\nadd 0 0 255\nadd 100 100 100\ntwinkle")'>icy</button>
        <button onmousedown="command('explosion')">explosion</button>
        <button onmousedown="command('stripes')">stripes</button>

        <h2>Set color</h2>
        <color-button r="50" g="35" b="15" name="warm"/>
        <color-button r="50" g="50" b="50" name="snow"/>
        <color-button r="30" g="0" b="0" name="red"/>
        <color-button r="60" g="20" b="20" name="pink"/>
        <color-button r="0" g="30" b="0" name="green"/>
        <color-button r="0" g="0" b="30" name="blue"/>
        <color-button r="30" g="0" b="30" name="purple"/>
        <color-button r="40" g="30" b="0" name="yellow"/>
        <color-button r="0" g="30" b="30" name="teal"/>
        <color-button r="0" g="0" b="0" name="black"/>
        <h2>Add color</h2>
        <color-button r="50" g="35" b="15" method="add" name="warm"/>
        <color-button r="50" g="50" b="50" method="add" name="snow"/>
        <color-button r="30" g="0" b="0"   method="add" name="red"/>
        <color-button r="60" g="20" b="20" method="add" name="pink"/>
        <color-button r="0" g="30" b="0"   method="add" name="green"/>
        <color-button r="0" g="0" b="30"   method="add" name="blue"/>
        <color-button r="30" g="0" b="30"  method="add" name="purple"/>
        <color-button r="40" g="30" b="0"  method="add" name="yellow"/>
        <color-button r="0" g="30" b="30"  method="add" name="teal"/>
        <color-button r="0" g="0" b="0"    method="add" name="black"/>


        <h2>Color Schemes</h2>
        <button onmousedown="command('color 0 70 30\nadd 0 55 45')">aqua</button>
        <button onmousedown="command('color 50 0 0\nadd 30 10 10')">vday</button>
        <button onmousedown="command('color 40 2 0\nadd 30 25 0\nadd 3 3 35\nadd 40 10 0\nadd 3 40 3')">match</button>

        <h2>Rainbow Config</h2>
        brightness: <input id='brightness' class='slider' type='range' min="0" max="255" oninput="brightness_input()" onchange="brightness_change()"></input>  <div style='display:inline-block' id='brightness_value'></div><br>
        saturation: <input id='saturation' class='slider' type='range' min="0" max="255" oninput="saturation_input()" onchange="saturation_change()"></input>  <div style='display:inline-block' id='saturation_value'></div><br>
        speed: <input id='speed' class='slider' type='range' min="1" max="100" oninput="speed_input()" onchange="speed_change()"></input>  <div style='display:inline-block' id='speed_value'></div><br>
        cycles: <input id='cycles'class='slider' type="range"  min="1" max="100" value="10" oninput="cycles_input()" onchange="cycles_change()"></input> <div style='display:inline-block' id='cycles_value'></div><br>

        <h2><a href='command_line.html'>command_line.html</a></h2>
    </body>
</html>